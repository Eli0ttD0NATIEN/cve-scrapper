"use strict";

const { JSDOM } = require('jsdom');
const axios = require('axios');

class VulnScrapper{
    constructor(CVE_URL, products, last){
        this.CVE_URL = CVE_URL;
        this.products = products;
        this.last = last;
        this.allVuln = [];
    }

    requestVuln = async (keyword) => {
        try {
            const resp = await axios.get(this.CVE_URL + keyword);
            return resp.data;
        } catch (err) {
            console.log(err);
            exit(1, "Request Failed");
        }
    }
    
    scrapVuln = (resp) => {
        const document = new JSDOM(resp).window.document;
        const vulnTable = document.getElementById("TableWithRules").textContent;
        return vulnTable;
    }
    
    setVuln = async () => {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
        this.allVuln = [];
        for(let i in this.products){
            let prod = this.products[i];
            const resp = await this.requestVuln(prod);

            let vulnTable = this.scrapVuln(resp).split('\n');
            vulnTable = vulnTable.filter(function(entry) { return entry.trim() != ''; });
            vulnTable = vulnTable.map(elem => elem.trim());
            vulnTable.splice(0,2);

            let vulnerabilityDict = {};
            for(let i = 0; i < vulnTable.length; i+=2){
                vulnerabilityDict[vulnTable[i]] = vulnTable[i+1];
            }
            this.allVuln = vulnerabilityDict;
            this.transformVuln();
        }
    }

    transformVuln = () => {
        const vulnTableLen = Object.keys(this.allVuln).length;
        this.len = vulnTableLen;
        if(vulnTableLen > 0){
            const vulnTable = [];
            for(let i = 0; i < vulnTableLen; i++){
                vulnTable.push(Object.entries(this.allVuln)[i].join(" : ")); //Get specific line of obj
            }
            this.allVuln = vulnTable;
        }
    }

    getVuln = () => {
        if(this.len > 0){
            if(this.last){
                return this.allVuln[0];
            }
            return this.allVuln;  
        } 
        return false;
    }
}
 
module.exports.VulnScrapper = VulnScrapper;