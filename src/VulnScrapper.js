"use strict";

const { JSDOM } = require('jsdom');
const axios = require('axios');

class VulnScrapper{
    constructor(CVE_URL, products, last){
        this.CVE_URL = CVE_URL;
        this.products = products;
        this.last = last;
        this.allVuln = [];
    }

    requestVuln = async (keyword) => {
        try {
            const resp = await axios.get(this.CVE_URL + keyword);
            return resp.data;
        } catch (err) {
            console.log(err);
            exit(1, "Request Failed");
        }
    }
    
    scrapVuln = (resp) => {
        const document = new JSDOM(resp).window.document;
        const vulnTable = document.getElementById("TableWithRules").textContent;
        return vulnTable;
    }
    
    setVuln = async () => {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
        this.allVuln = {};
        for(let i in this.products){
            let prod = this.products[i];
            const resp = await this.requestVuln(prod);

            let vulnTable = this.scrapVuln(resp).split('\n');
            vulnTable = vulnTable.filter(function(entry) { return entry.trim() != ''; });
            vulnTable = vulnTable.map(elem => elem.trim());
            vulnTable.splice(0,2);

            let vulnerabilityDict = {};
            for(let i = 0; i < vulnTable.length; i+=2){
                vulnerabilityDict[vulnTable[i]] = vulnTable[i+1];
            }
            (this.products.length > 1) ? this.allVuln[prod] = vulnerabilityDict : this.allVuln = vulnerabilityDict;
        }
        this.transformVuln();
    }

    transformVuln = () => {
        if(this.products.length > 1){
            this.len = []
            const newArr = Object.entries(this.allVuln);
            this.allVuln = []
            for(let i = 0; i < this.products.length; i++){
                const prodVulnLen = Object.keys(newArr[i][1]).length;
                this.len.push(prodVulnLen);
                this.allVuln.push(this.objToLine(newArr[i][1], prodVulnLen, " : "))
            }
        } else {
            const prodVulnLen = Object.keys(this.allVuln).length;
            this.len = prodVulnLen;
            if(prodVulnLen > 0){
                this.allVuln = this.objToLine(this.allVuln, prodVulnLen, " : ");
            }
        }
        return 0; 
    }

    objToLine = (obj, len, separator) => {
        const arr = [];
        for(let i = 0; i < len; i++){
            arr.push(Object.entries(obj)[i].join(separator)); //Get specific line of obj
        }
        return arr;
    }

    getVuln = () => {
        if(this.products.length > 1){
            if(this.checkLen()){
                if(this.last){
                    let lastVulnArr = [];
                    for(let prod in this.allVuln){
                        lastVulnArr.push(this.allVuln[prod][0]);
                    }
                    return lastVulnArr;
                }else{
                    return this.allVuln;
                }
            }
            return false;
        }else{
            if(this.len > 0){
                if(this.last){
                    return this.allVuln[0];
                }
                return this.allVuln;  
            }
        }
        return false;
    }

    checkLen = () => {
        for(let len in this.len){
            if(this.len[len] == 0){
                return false
            }
        }
        return true;
    }
}
 

module.exports.VulnScrapper = VulnScrapper;